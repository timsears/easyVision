import Vision.GUI
import ImagProc
import Contours
import Vision
import Contours.Clipping
import Data.List(partition)
import Util.Misc(debug)

main = runIt win

win = browser "clipping" ds (const id)
    where
      ds = [ msg "original contours" [color blue a, color red b]
           , msg "XOR" [color blue (map (fst.fst) zp), color red (map (fst.fst) zn)]
           , msg "delta" (drawDelta deltas)
           , msg "delta" (drawDelta (deltaContour a b))
           , msg "deltabug" (drawDelta doubleBug)
           , msg "deltaBug2" (drawDelta (deltaContour aDouble bDouble))
           ]
   --        ++ map (msg "positive" . color blue . shOrig) zp
   --        ++ map (msg "negative" . color red  . shOrig) zn


a' = Closed [Point x1 y1, Point 0 y1, Point x2 y1, Point x2 y2, Point x1 y2]
  where
    x1 = 0.6; x2 = -x1; y1 = 0.4; y2 = -y1

b' = Closed [ Point x1 y2,  Point x1 0, Point x1 y1, Point x2 y1, Point x2 y2
           , Point x4 y2, Point x4 y3, Point x3 y3, Point x3 y2]
  where
    x1 = 0.4; x2 = -x1; x3 = 0.2; x4 = -x3;
    y1 = 0.8; y2 = -0.6; y3 = 0.6


a'' = Closed [Point x1 y0, Point x8 y0, Point x8 y7, Point x6 y7, Point x6 y1
           , Point x4 y1, Point x4 y7, Point x3 y7, Point x3 y1, Point x2 y1
           , Point x2 y7, Point x1 y7 ]
  where
    x0 = 0.9; x1 = 0.8; x2 = 0.4; x3 = 0.2; x4 =  0.0; x5 = -0.2; x6 = -0.4; x7 = -0.6; x8 = -0.8; x9 = -0.9;
    y0 = 0.8; y1 = 0.4; y2 = 0.2; y3 = 0.0; y4 = -0.2; y5 = -0.4; y6 = -0.6; y7 = -0.8;

b'' = Closed [Point x0 y2, Point x9 y2, Point x9 y6, Point x0 y6, Point x0 y5 
           , Point x7 y5, Point x7 y4, Point x5 y4, Point x5 y3, Point x0 y3]
  where
    x0 = 0.9; x1 = 0.8; x2 = 0.4; x3 = 0.2; x4 =  0.0; x5 = -0.2; x6 = -0.4; x7 = -0.6; x8 = -0.8; x9 = -0.9;
    y0 = 0.8; y1 = 0.4; y2 = 0.2; y3 = 0.0; y4 = -0.2; y5 = -0.4; y6 = -0.6; y7 = -0.8;


deltas = deltaContour b a

(zp,zn) = partition ((<0).snd.fst) deltas


msg s d = Draw [winTitle s, Draw d]

shOrig :: (Polyline, [Int]) -> Drawing
shOrig (p, os) = Draw [Draw p, color white $ drawThings (polyPts p) (zip [0..] os)]

drawThings pts xs = draws $ zipWith (textF Helvetica10) pts (map ((' ':).show) xs)


drawDelta = Draw . map shDelta
  where
    shDelta ((_,oa),bs) = color c bs
      where
        c | oa < 0 = blue
          | otherwise = red


(abug,bbug) = (Closed {polyPts = [Point {px = -0.20782354230467645, py = -9.313176855867426e-2},Point {px = -0.373691244681037, py = -9.63207857734842e-2},Point {px = -0.4532415606894818, py = -0.13805032936096592},Point {px = -0.9057799447203816, py = -0.25127649349486203},Point {px = -0.5168077114432317, py = -0.14968476446231596},Point {px = -0.4036462677777077, py = -0.12340506652447494}]},Closed {polyPts = [Point {px = -0.5571559071540833, py = 8.839972433634102e-4},Point {px = -0.5287163257598877, py = -5.327197164297104e-2},Point {px = -0.5075118541717529, py = -9.433480352163315e-2},Point {px = -0.5550975799560547, py = -0.10797053575515747},Point {px = -0.5856568813323975, py = -0.11764708906412125},Point {px = -0.565544843673706, py = -0.1406146138906479},Point {px = -0.5531058311462402, py = -0.1528235524892807},Point {px = -0.5343605279922485, py = -0.14698220789432526},Point {px = -0.3986378014087677, py = -0.10871192067861557},Point {px = -0.46634629368782043, py = -4.173432942479849e-3},Point {px = -0.4821145236492157, py = 1.7320431768894196e-2},Point {px = -0.48549777269363403, py = 1.6965093091130257e-2}]})


aDouble2 = Closed [Point (-1) (-1), Point 1 (-1), Point 1 1, Point (-1) 1]
bDouble2 = Closed [Point x1 y1, Point x6 y1, Point x6 y2, Point x5 y2, Point x5 y4,
                   Point x2 y4, Point x2 y3, Point x3 y3, Point x3 y5, Point x4 y5, Point x4 y2,
                   Point x1 y2 ]
  where
    y1 = -0.5
    y2 = 0.5
    y3 = 0.6
    y4 = 1.2
    y5 = 1.1
    
    x1 = 1.1
    x2 = 0.9
    x3 = 0.8
    x4 = 0.7
    x5 = 0.6
    x6 = -1.1

(a,b) = (g aerror, g berror)-- (g aDouble2, g bDouble2) -- (g abug2, g bbug2)
  where
    g = transPol (scaling 0.1)

(abug2,bbug2) = (Closed {polyPts = [Point {px = -1.0, py = 1.0},Point {px = 0.5409089027863764, py = 1.0},Point {px = 0.5409089027863764, py = 0.5409089027863764},Point {px = 1.0, py = 0.5409089027863764},Point {px = 1.0, py = -1.0},Point {px = -1.0, py = -1.0}]},Closed {polyPts = [Point {px = 1.0461806328931726, py = -1.0533110935239938},Point {px = 1.0323399253198746, py = -1.039564869887659},Point {px = 1.014900304936005, py = -1.0146528169244553},Point {px = 1.022788829650742, py = -0.9881410452615857},Point {px = 1.028325769585851, py = -0.9070272594380744},Point {px = 1.013516069523226, py = -0.8427087254114509},Point {px = 1.0089564024059414, py = -0.5798712901677733},Point {px = 0.9870527094697498, py = -0.2733846975750315},Point {px = 0.9758625235656957, py = -0.24218880530096729},Point {px = 0.9798684716222997, py = -0.21421990438120792},Point {px = 0.9147137844313992, py = 0.7037264535211735},Point {px = 0.9280212551697442, py = 0.7195437046822099},Point {px = 0.9642019137954511, py = 0.7275975578005307},Point {px = 0.9995092302190751, py = 0.7109367779325695},Point {px = 0.9847181427064869, py = 0.5096699314450556},Point {px = 0.9959174286720239, py = 0.5018075747680507},Point {px = 1.006438363521922, py = 0.553969892877748},Point {px = 1.0095068020938829, py = 0.7771989871151818},Point {px = 0.9637698191989975, py = 0.7746502589316928},Point {px = 0.9585951519432351, py = 0.7597354240620862},Point {px = 0.5127452637307122, py = 0.9259402861627014},Point {px = 0.14575152161925722, py = 0.9828461310422835},Point {px = -5.213923675151695e-2, py = 0.9932031389122915},Point {px = -0.48262032183470605, py = 0.9697420007112659},Point {px = -0.685546653214523, py = 0.9380567636001031},Point {px = -1.0439557011507605, py = 0.832135627298649},Point {px = -1.0792260759988408, py = 0.8110871502490191},Point {px = -1.024067004863906, py = 5.816659649778676e-2},Point {px = -0.9488212085934068, py = -1.048481079123252},Point {px = -0.9106120908786688, py = -1.053108950986663},Point {px = -0.4608589886454261, py = -0.9884059807665415},Point {px = -0.12071759837992606, py = -0.9705722756692597},Point {px = 0.20034888373747242, py = -0.9683383345100647},Point {px = 0.5079046252710107, py = -0.9875190877912031},Point {px = 0.8202258965835505, py = -1.026459240859009},Point {px = 1.0176998187798558, py = -1.0638916665851768}]})


doubleBug = [((Closed {polyPts = [Point {px = -0.8647087616898923, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413},Point {px = 0.21688771047994926, py = -3.8491899331335917},Point {px = -0.1352572069354011, py = -2.8508728786834863},Point {px = -6.92568367876015e-2, py = -2.8992202180015627},Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.976343884113463, py = -0.8468880904333413},Point {px = -0.9524454978667649, py = -0.8799538109964984},Point {px = -0.9765679111007428, py = -0.8829618886622057},Point {px = -0.970032783444179, py = -0.9111743775371497},Point {px = -0.942868102858814, py = -0.9510719194569155},Point {px = -0.9411493317123041, py = -0.9796462549323833},Point {px = -0.929140319891241, py = -0.9913859448269472},Point {px = -0.8951767682389525, py = -1.0038706297955264},Point {px = -0.882347499821958, py = -0.9953103113514286},Point {px = -0.869694511527761, py = -1.012211651840492},Point {px = -0.8583114560688708, py = -1.0102167087437013},Point {px = -0.8658611502957732, py = -0.99270419675643},Point {px = -0.8628283486482806, py = -0.9886957612249042},Point {px = -0.8512646289543858, py = -1.0029706106678133},Point {px = -0.8404120658270996, py = -0.9905927873758107},Point {px = -0.8213314101570777, py = -0.9898645595649548},Point {px = -0.8103042679547586, py = -0.9808516746824855},Point {px = -0.7959232930198722, py = -0.9898818046734058},Point {px = -0.7945222417828741, py = -0.9830387697614571},Point {px = -0.8053671168237386, py = -0.963276895287801},Point {px = -0.8084762991513821, py = -0.9219072586417855},Point {px = -0.8269202821627244, py = -0.9155490667729177},Point {px = -0.8259431968418127, py = -0.9430723729231365},Point {px = -0.8208922523783179, py = -0.9544297133242317},Point {px = -0.8149439980142154, py = -0.9376769383189305},Point {px = -0.8098068826897679, py = -0.9410844054983963},Point {px = -0.8094764583289444, py = -0.953497843099409},Point {px = -0.8250064181679164, py = -0.9684237281171438},Point {px = -0.8376687312009434, py = -0.9229577989462883},Point {px = -0.8445516378821615, py = -0.8464176540971234},Point {px = -0.8483468232086514, py = -0.8728827385805453},Point {px = -0.8583182069064954, py = -0.8654292243569355}]},-1.0619539161811759e-3),[Open {polyPts = [Point {px = -0.8647087616898923, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413}]}]),((Closed {polyPts = [Point {px = -0.8647087616898923, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413},Point {px = 0.21688771047994926, py = -3.8491899331335917},Point {px = -0.1352572069354011, py = -2.8508728786834863},Point {px = -6.92568367876015e-2, py = -2.8992202180015627},Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.976343884113463, py = -0.8468880904333413},Point {px = -0.9524454978667649, py = -0.8799538109964984},Point {px = -0.9765679111007428, py = -0.8829618886622057},Point {px = -0.970032783444179, py = -0.9111743775371497},Point {px = -0.942868102858814, py = -0.9510719194569155},Point {px = -0.9411493317123041, py = -0.9796462549323833},Point {px = -0.929140319891241, py = -0.9913859448269472},Point {px = -0.8951767682389525, py = -1.0038706297955264},Point {px = -0.882347499821958, py = -0.9953103113514286},Point {px = -0.869694511527761, py = -1.012211651840492},Point {px = -0.8583114560688708, py = -1.0102167087437013},Point {px = -0.8658611502957732, py = -0.99270419675643},Point {px = -0.8628283486482806, py = -0.9886957612249042},Point {px = -0.8512646289543858, py = -1.0029706106678133},Point {px = -0.8404120658270996, py = -0.9905927873758107},Point {px = -0.8213314101570777, py = -0.9898645595649548},Point {px = -0.8103042679547586, py = -0.9808516746824855},Point {px = -0.7959232930198722, py = -0.9898818046734058},Point {px = -0.7945222417828741, py = -0.9830387697614571},Point {px = -0.8053671168237386, py = -0.963276895287801},Point {px = -0.8084762991513821, py = -0.9219072586417855},Point {px = -0.8269202821627244, py = -0.9155490667729177},Point {px = -0.8259431968418127, py = -0.9430723729231365},Point {px = -0.8208922523783179, py = -0.9544297133242317},Point {px = -0.8149439980142154, py = -0.9376769383189305},Point {px = -0.8098068826897679, py = -0.9410844054983963},Point {px = -0.8094764583289444, py = -0.953497843099409},Point {px = -0.8250064181679164, py = -0.9684237281171438},Point {px = -0.8376687312009434, py = -0.9229577989462883},Point {px = -0.8445516378821615, py = -0.8464176540971234},Point {px = -0.8483468232086514, py = -0.8728827385805453},Point {px = -0.8583182069064954, py = -0.8654292243569355}]},-2.8149629039424192e-2),[Open {polyPts = [Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.976343884113463, py = -0.8468880904333413}]}]),((Closed {polyPts = [Point {px = -1.0, py = -0.8141575742621096},Point {px = -1.0, py = -0.6444504443811592},Point {px = -1.5981784501696858, py = 0.8046654255851253},Point {px = -1.1622571285408594, py = -0.34682712294290224},Point {px = -1.037748316496657, py = -0.6130671832576412},Point {px = -1.126423484004219, py = -0.6392385001642994}]},-4.423297502120507e-2),[Open {polyPts = [Point {px = -1.0, py = -0.8141575742621096},Point {px = -1.0, py = -0.6444504443811592}]}]),((Closed {polyPts = [Point {px = -1.0, py = -0.5150458767684465},Point {px = -1.0, py = -0.4783893089517677},Point {px = -1.0419980740601722, py = -0.36205389604778837}]},-7.697526249783044e-4),[Open {polyPts = [Point {px = -1.0, py = -0.5150458767684465},Point {px = -1.0, py = -0.4783893089517677}]}]),((Closed {polyPts = [Point {px = -0.8896085425755462, py = -0.7746455093559507},Point {px = -0.8978077949083212, py = -0.792895972319122},Point {px = -0.8947668294042176, py = -0.8390326013346664},Point {px = -0.9018841282655816, py = -0.8466397519889486},Point {px = -0.9228269945286665, py = -0.7700007151571504},Point {px = -0.9196331564970337, py = -0.735881909354888},Point {px = -0.9669670663713181, py = -0.6353793458133685},Point {px = -1.0, py = -0.5150458767684465},Point {px = -1.0, py = -0.6444504443811592},Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413},Point {px = -1.0, py = -0.4783893089517677},Point {px = -1.0, py = 1.0},Point {px = -0.8468880904333413, py = 1.0},Point {px = -0.8468880904333413, py = -0.8468880904333413},Point {px = -0.8647087616898923, py = -0.8468880904333413}]},0.2361780514941178),[Open {polyPts = [Point {px = -1.0, py = -0.4783893089517677},Point {px = -1.0, py = 1.0},Point {px = -0.8468880904333413, py = 1.0},Point {px = -0.8468880904333413, py = -0.8468880904333413},Point {px = -0.8647087616898923, py = -0.8468880904333413}]}]),((Closed {polyPts = [Point {px = -0.8896085425755462, py = -0.7746455093559507},Point {px = -0.8978077949083212, py = -0.792895972319122},Point {px = -0.8947668294042176, py = -0.8390326013346664},Point {px = -0.9018841282655816, py = -0.8466397519889486},Point {px = -0.9228269945286665, py = -0.7700007151571504},Point {px = -0.9196331564970337, py = -0.735881909354888},Point {px = -0.9669670663713181, py = -0.6353793458133685},Point {px = -1.0, py = -0.5150458767684465},Point {px = -1.0, py = -0.6444504443811592},Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413},Point {px = -1.0, py = -0.4783893089517677},Point {px = -1.0, py = 1.0},Point {px = -0.8468880904333413, py = 1.0},Point {px = -0.8468880904333413, py = -0.8468880904333413},Point {px = -0.8647087616898923, py = -0.8468880904333413}]},3.341641166309957e-3),[Open {polyPts = [Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413}]}]),((Closed {polyPts = [Point {px = -0.8896085425755462, py = -0.7746455093559507},Point {px = -0.8978077949083212, py = -0.792895972319122},Point {px = -0.8947668294042176, py = -0.8390326013346664},Point {px = -0.9018841282655816, py = -0.8466397519889486},Point {px = -0.9228269945286665, py = -0.7700007151571504},Point {px = -0.9196331564970337, py = -0.735881909354888},Point {px = -0.9669670663713181, py = -0.6353793458133685},Point {px = -1.0, py = -0.5150458767684465},Point {px = -1.0, py = -0.6444504443811592},Point {px = -0.91643605602476, py = -0.8468880904333413},Point {px = -0.866968804000205, py = -0.8468880904333413},Point {px = -1.0, py = -0.4783893089517677},Point {px = -1.0, py = 1.0},Point {px = -0.8468880904333413, py = 1.0},Point {px = -0.8468880904333413, py = -0.8468880904333413},Point {px = -0.8647087616898923, py = -0.8468880904333413}]},8.7416141496708e-3),[Open {polyPts = [Point {px = -1.0, py = -0.5150458767684465},Point {px = -1.0, py = -0.6444504443811592}]}]),((Closed {polyPts = [Point {px = -1.0, py = -0.8141575742621096},Point {px = -1.0, py = -1.0},Point {px = -1.0530446192292915, py = -1.0},Point {px = -1.0530446192292915, py = -0.8468880904333413},Point {px = -0.976343884113463, py = -0.8468880904333413}]},7.734624500646706e-3),[Open {polyPts = [Point {px = -1.0, py = -0.8141575742621096},Point {px = -1.0, py = -1.0},Point {px = -1.0530446192292915, py = -1.0},Point {px = -1.0530446192292915, py = -0.8468880904333413},Point {px = -0.976343884113463, py = -0.8468880904333413}]}])]

aDouble =(Closed {polyPts = [Point {px = 0.20161, py = 0.84649}, Point {px = 0.20161, py = 0.20322}, Point {px = 0.73618, py = 0.20614}, Point {px = 0.73618, py = 0.82895}]})

bDouble = (Closed {polyPts = [Point {px = 0.33952, py = 0.89365}, Point {px = 0.33952, py = 0.71821}, Point {px = 0.74113, py = 0.89832}, Point {px = 0.79919, py = 0.76499}, Point {px = 0.46855, py = 0.17084}, Point {px = 0.63952, py = 0.12639}, Point {px = 0.78790, py = 0.46090}]})


berror = Closed {polyPts = [Point {px = -0.7087473843158856, py = -0.9526372718844915},Point {px = -0.699239505922532, py = -0.9598391598029998},Point {px = -0.6965988304898396, py = -1.0090361705759143},Point {px = -0.6737214892863356, py = -0.9812131100526089},Point {px = -0.659844893012099, py = -0.9042853343861089},Point {px = -0.6320713652174572, py = -0.8768437781919048},Point {px = -0.6280580063667309, py = -0.881953617757971},Point {px = -0.6723241554732983, py = -1.0503196486764905},Point {px = -0.7602318269252131, py = -1.378844840936902},Point {px = -0.8710330099847384, py = -1.4296185046199605},Point {px = -1.0064480745189623, py = -1.7451078525977932},Point {px = -1.415594984859816, py = -3.442170068747284},Point {px = -1.1541367634197632, py = -3.1304945885158437},Point {px = 0.2213059340544179, py = 3.0228468915783204},Point {px = -0.35150354839488446, py = 0.7900913662799258},Point {px = -0.39219621663720194, py = 0.8672196436922212},Point {px = -0.4877139617657131, py = 0.2726256452494129},Point {px = -0.48363582368011676, py = 0.1525226656572647},Point {px = -0.47148661237555417, py = 0.11562879757512322},Point {px = -0.3497590495681353, py = 0.25525812263846764},Point {px = 0.5392422525656817, py = 2.404442937982389},Point {px = -1.3064032626758577, py = -2.6712861551831044},Point {px = -1.4843500199952202, py = -2.5414751549556747},Point {px = -2.125537462058009, py = -3.4209802536181626},Point {px = -9.118533923513417e-2, py = -0.13077014897239694},Point {px = 4.849538336049922e-2, py = -0.10742322828010199}]}
aerror =  Closed {polyPts = [Point {px = -1.0, py = 1.0},Point {px = 28.158144190866572, py = 1.0},Point {px = 28.158144190866572, py = 28.158144190866572},Point {px = 32.35511786940818, py = 28.158144190866572},Point {px = 32.35511786940818, py = -1.0},Point {px = -1.0, py = -1.0}]}


